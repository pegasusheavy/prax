name: Fuzz Testing

on:
  # Run weekly on Sunday at midnight
  schedule:
    - cron: '0 0 * * 0'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      duration:
        description: 'Fuzzing duration per target (seconds)'
        required: false
        default: '300'
      target:
        description: 'Specific target to fuzz (leave empty for all)'
        required: false
        default: ''

env:
  CARGO_TERM_COLOR: always

jobs:
  fuzz:
    name: Fuzz ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - fuzz_schema_parser
          - fuzz_schema_structured
          - fuzz_query_builder
          - fuzz_filter_construction
          - fuzz_sql_builder
          - fuzz_config_parser

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-fuzz-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache fuzz corpus
        uses: actions/cache@v5
        with:
          path: fuzz/corpus
          key: ${{ runner.os }}-fuzz-corpus-${{ matrix.target }}-${{ github.run_number }}
          restore-keys: |
            ${{ runner.os }}-fuzz-corpus-${{ matrix.target }}-

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Check if target should run
        id: check
        run: |
          TARGET="${{ github.event.inputs.target }}"
          if [ -z "$TARGET" ] || [ "$TARGET" = "${{ matrix.target }}" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Run fuzzer
        if: steps.check.outputs.should_run == 'true'
        working-directory: fuzz
        run: |
          DURATION="${{ github.event.inputs.duration }}"
          DURATION="${DURATION:-300}"

          echo "Fuzzing ${{ matrix.target }} for ${DURATION}s"
          cargo +nightly fuzz run ${{ matrix.target }} -- \
            -max_total_time=${DURATION} \
            -print_final_stats=1 \
            -dict=dict/schema.dict || true

      - name: Upload corpus
        if: steps.check.outputs.should_run == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: corpus-${{ matrix.target }}
          path: fuzz/corpus/${{ matrix.target }}/
          retention-days: 30

      - name: Check for crashes
        if: steps.check.outputs.should_run == 'true'
        id: crashes
        run: |
          CRASH_DIR="fuzz/artifacts/${{ matrix.target }}"
          if [ -d "$CRASH_DIR" ] && [ "$(ls -A $CRASH_DIR 2>/dev/null)" ]; then
            echo "has_crashes=true" >> $GITHUB_OUTPUT
            echo "::error::Crashes found in ${{ matrix.target }}"
          else
            echo "has_crashes=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload crashes
        if: steps.crashes.outputs.has_crashes == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: crashes-${{ matrix.target }}
          path: fuzz/artifacts/${{ matrix.target }}/
          retention-days: 90

  coverage:
    name: Fuzz Coverage Report
    runs-on: ubuntu-latest
    needs: fuzz
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Download all corpus artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: corpus-*
          path: fuzz/corpus/
          merge-multiple: true

      - name: Generate coverage report
        working-directory: fuzz
        run: |
          for target in fuzz_schema_parser fuzz_query_builder fuzz_filter_construction; do
            if [ -d "corpus/$target" ]; then
              echo "Generating coverage for $target"
              cargo +nightly fuzz coverage $target corpus/$target/ || true
            fi
          done

      - name: Summary
        run: |
          echo "## Fuzz Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          for target in fuzz_schema_parser fuzz_schema_structured fuzz_query_builder fuzz_filter_construction fuzz_sql_builder fuzz_config_parser; do
            if [ -d "fuzz/artifacts/$target" ] && [ "$(ls -A fuzz/artifacts/$target 2>/dev/null)" ]; then
              echo "| $target | âŒ Crashes found |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $target | âœ… No crashes |" >> $GITHUB_STEP_SUMMARY
            fi
          done

  notify-crashes:
    name: Notify on Crashes
    runs-on: ubuntu-latest
    needs: fuzz
    if: failure()

    steps:
      - name: Create issue for crashes
        uses: actions/github-script@v8
        with:
          script: |
            const targets = [
              'fuzz_schema_parser',
              'fuzz_schema_structured',
              'fuzz_query_builder',
              'fuzz_filter_construction',
              'fuzz_sql_builder',
              'fuzz_config_parser'
            ];

            const body = `## Fuzz Testing Crashes Detected

            The weekly fuzz testing run found potential crashes.

            **Run:** ${context.runId}
            **Date:** ${new Date().toISOString()}

            Please investigate the crash artifacts uploaded to this workflow run.

            ### Steps to reproduce locally:

            1. Download the crash artifacts from the workflow run
            2. Run: \`cargo +nightly fuzz run <target> <crash_file>\`
            3. Debug and fix the issue
            4. Add a regression test
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”´ Fuzz Testing: Crashes Detected',
              body: body,
              labels: ['bug', 'security', 'fuzzing']
            });

